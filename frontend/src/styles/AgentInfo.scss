import { useNavigate } from "react-router-dom";
import { useState, useRef, useContext } from "react";
import axiosClient from "../api/axiosClient";
import SignatureCanvas from "react-signature-canvas";
import "../styles/AgentInfo.scss";
import { CartContext } from "../context/CartContext";

export default function AgentInfo() {
  const navigate = useNavigate();
  const { clearCart, cart } = useContext(CartContext);

  const [agentName, setAgentName] = useState("");
  const [magazinName, setMagazinName] = useState("");
  const [cui, setCui] = useState("");
  const [address, setAddress] = useState("");
  const [responsiblePerson, setResponsiblePerson] = useState("");

  const [popup, setPopup] = useState({ show: false, message: "", type: "" });

  const sigCanvas = useRef(null);

  const showPopup = (message, type = "success") => {
    setPopup({ show: true, message, type });
    setTimeout(() => setPopup({ show: false, message: "", type: "" }), 3000);
  };

  const sendOrder = async () => {
    if (
      !agentName.trim() ||
      !magazinName.trim() ||
      !cui.trim() ||
      !address.trim() ||
      !responsiblePerson.trim()
    ) {
      showPopup("Vă rugăm completați toate câmpurile!", "error");
      return;
    }

    if (cart.length === 0) {
      showPopup("Coșul este gol!", "error");
      return;
    }

    let signatureData = "";
    if (sigCanvas.current && !sigCanvas.current.isEmpty()) {
      signatureData = sigCanvas.current.getCanvas().toDataURL("image/png");
    } else {
      showPopup("Vă rugăm să semnați!", "error");
      return;
    }

    const items = cart.map((item) => ({
      _id: item._id || item.product?._id,
      name: item.name || item.product?.name || "Produs fără nume",
      boxes: Number(item.boxes || 0),
      quantity: Number(item.quantity || 0),
      price: Number(item.customPrice ?? item.price ?? 0),
      unitsPerBox: Number(item.unitsPerBox || 1),
    }));

    const invalidItem = items.find((i) => !i._id);
    if (invalidItem) {
      showPopup(`Produs invalid în coș: ${invalidItem.name}`, "error");
      return;
    }

    const data = {
      items,
      agentName: agentName.trim(),
      magazinName: magazinName.trim(),
      cui: cui.trim(),
      address: address.trim(),
      responsiblePerson: responsiblePerson.trim(),
      signature: signatureData,
    };

    try {
      const token = localStorage.getItem("token");
      axiosClient.defaults.headers.common["Authorization"] = token
        ? `Bearer ${token}`
        : "";

      await axiosClient.post("/orders/create", data);

      showPopup("Comanda trimisă cu succes!", "success");
      clearCart();
      sigCanvas.current?.clear();

      setAgentName("");
      setMagazinName("");
      setCui("");
      setAddress("");
      setResponsiblePerson("");

      navigate("/");
    } catch (err) {
      console.error("Error sending order:", err);
      showPopup(
        err.response?.data?.message || "Eroare la trimiterea comenzii.",
        "error"
      );
    }
  };

  const clearSignature = () => sigCanvas.current?.clear();

  return (
    <div className="agent-info">
      <h2>Completează detaliile comenzii</h2>

      <div className="form-container">
        <input
          type="text"
          placeholder="Nume agent"
          value={agentName}
          onChange={(e) => setAgentName(e.target.value)}
        />
        <input
          type="text"
          placeholder="Nume magazin"
          value={magazinName}
          onChange={(e) => setMagazinName(e.target.value)}
        />
        <input
          type="text"
          placeholder="CUI"
          value={cui}
          onChange={(e) => setCui(e.target.value)}
        />
        <input
          type="text"
          placeholder="Adresa de livrare"
          value={address}
          onChange={(e) => setAddress(e.target.value)}
        />
        <input
          type="text"
          placeholder="Persoană responsabilă"
          value={responsiblePerson}
          onChange={(e) => setResponsiblePerson(e.target.value)}
        />

        <div className="signature-container">
          <label>Semnătură:</label>
          <SignatureCanvas
            ref={sigCanvas}
            penColor="black"
            canvasProps={{
              width: 500,
              height: 200,
              className: "sigCanvas",
              style: { border: "1px solid #ccc", borderRadius: "5px" },
            }}
          />
          <button type="button" onClick={clearSignature}>
            Șterge semnătura
          </button>
        </div>

        <button className="submit-btn" onClick={sendOrder}>
          Trimis
        </button>
      </div>

      {/* Popup notification */}
      {popup.show && (
        <div className={`popup ${popup.type} show`}>
          {popup.message}
        </div>
      )}
    </div>
  );
}
